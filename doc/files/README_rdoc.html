<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>File: README.rdoc</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



  <div id="fileHeader">
    <h1>README.rdoc</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>README.rdoc
      </td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Mar 29 17:25:34 -0600 2009</td>
    </tr>
    </table>
  </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <h1><a href="../classes/Teeth.html">Teeth</a></h1>
<p>
<a href="../classes/Teeth.html">Teeth</a> is a library for fast parsing of
log files such as Apache access and error logs. It uses C extensions
generated by <a href="http://flex.sourceforge.net/index.html">flex</a> (as
in Flex and Bison). If you only want to use the built-in scanners, you
don&#8216;t need flex. If you want to add support for new/different log
formats, you&#8216;ll need to have flex installed.
</p>
<h1>Example</h1>
<pre>
 require &quot;teeth&quot;

 access_log = %q{myhost.localdomain:80 172.16.115.1 - - [13/Dec/2008:19:26:11 -0500] &quot;GET /favicon.ico HTTP/1.1&quot; 404 241 &quot;http://172.16.115.130/&quot; &quot;Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_4_11; en) AppleWebKit/525.27.1 (KHTML, like Gecko) Version/3.2.1 Safari/525.27.1&quot;}
 access_log.scan_apache_logs
        =&gt;   {:strings=&gt;[&quot;241&quot;],
                                :apache_access_datetime=&gt;[&quot;13/Dec/2008:19:26:11 -0500&quot;],
                                :absolute_url=&gt;[&quot;http://172.16.115.130/&quot;],
                                :message=&gt;&quot;myhost.localdomain:80 172.16.115.1 - - [13/Dec/2008:19:26:11 -0500] \&quot;GET /favicon.ico HTTP/1.1\&quot; 404 241 \&quot;http://172.16.115.130/\&quot; \&quot;Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_4_11; en) AppleWebKit/525.27.1 (KHTML, like Gecko) Version/3.2.1 Safari/525.27.1\&quot;&quot;,
                                :http_method=&gt;[&quot;GET&quot;],
                                :browser_string=&gt;[&quot;Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_4_11; en) AppleWebKit/525.27.1 (KHTML, like Gecko) Version/3.2.1 Safari/525.27.1&quot;],
                                :relative_url=&gt;[&quot;/favicon.ico&quot;],
                                :http_version=&gt;[&quot;HTTP/1.1&quot;],
                                :host=&gt;[&quot;myhost.localdomain:80&quot;],
                                :id=&gt;&quot;8AD5CBCC1CB011DE8CE10017F22FF48F&quot;,
                                :http_response=&gt;[&quot;404&quot;],
                                :ipv4_addr=&gt;[&quot;172.16.115.1&quot;]}
</pre>
<h1>Supported Log Formats</h1>
<ul>
<li>Apache (access and error logs)

</li>
<li>Rails

</li>
</ul>
<p>
Support for other web servers, app servers, and applications as well as
other types of servers (e.g., SMTP, etc.) and generic syslog logs is
planned for the future.
</p>
<h2>Creating Your Own Scanners</h2>
<p>
<a href="../classes/Teeth.html">Teeth</a> includes a library that can
generate a flex scanner definition using a simplified definition written in
ruby. This cuts down on the repetition involved in writing all the C code
by hand. The included scanners for Apache and Rails logs are defined this
way. You can find them in the scanners directory.
</p>
<p>
Here&#8216;s an example based on the definition for the Rails log scanner:
</p>
<pre>
        require File.dirname(__FILE__) + &quot;/../lib/teeth&quot;
        scanner = Teeth::Scanner.new(:rails_logs, File.dirname(__FILE__) + '/../ext/scan_rails_logs/')

        # Flex definitions are kinda like macros for regular expressions.
        # We include some of the included defaults here to make writing
        # the scanner easier
        scanner.load_default_definitions_for(:whitespace, :ip, :time, :web)

        # Add some more definitions
        scanner.definitions do |define|
          define.RAILS_TEASER '(processing|filter\ chain\ halted|rendered)'
          define.CONTROLLER_ACTION '[a-z0-9]+#[a-z0-9]+'

                # Scanner is case insensitive
                define.RAILS_ERROR_CLASS '([a-z]+\:\:)*[a-z]+error'

                # &quot;start conditions&quot; are a feature of flex that allows
                # us to have some regular expressions that are only active
                # when we tell the scanner to enter a certain state.  Here
                # we define the ``REQUEST_COMPLETED'' state, and specify
                # that it is exclusive.  This means that if the scanner is
                # in this state, it only matches rules written for this state
                define.REQUEST_COMPLETED :start_condition =&gt; :exclusive

        end

        # Define rules.  These are the actions that the scanner executes when
        # it sees text that matches a regular expression.  The default action
        # is to add :action_name =&gt; [matched_text] to the results Hash, or push
        # the matched text on the end of the array if it already exists.
        scanner.rules do |r|

                # will add something like :teaser =&gt; [&quot;Processing&quot;] to the results
          r.teaser '{RAILS_TEASER}'
          r.controller_action '{CONTROLLER_ACTION}'

                # Use some of the default definitions we added above.
          r.datetime '{YEAR}&quot;-&quot;{MONTH_NUM}&quot;-&quot;{MDAY}{WS}{HOUR}&quot;:&quot;{MINSEC}&quot;:&quot;{MINSEC}'
          r.http_method '{HTTP_VERB}'

                # With :skip_line =&gt; true, scanner stops processing the line immediately
          r.skip_lines '{RAILS_SKIP_LINES}', :skip_line =&gt; true

          r.error '{RAILS_ERROR_CLASS}'

                # with :strip_ends =&gt; true, scanner removes first and last characters from matched text
          r.error_message '\(({WS}|{NON_WS})+\)', :strip_ends =&gt; true

                # Puts scanner in the ``REQUEST_COMPLETED'' state we defined above.
                # The scanner only matches rules beginning with ``&lt;REQUEST_COMPLETED&gt;''
                # now
          r.teaser 'completed\ in', :begin =&gt; &quot;REQUEST_COMPLETED&quot;

                # These rules only apply to the ``REQUEST_COMPLETED'' State
                r.duration_s '&lt;REQUEST_COMPLETED&gt;[0-9]+\.[0-9]+'
          r.duration_ms '&lt;REQUEST_COMPLETED&gt;[0-9]+/ms'
          r.http_response '&lt;REQUEST_COMPLETED&gt;{HTTPCODE}'

                # Need a &quot;catchall&quot; rule -- flex scanner &quot;jams&quot; if there isn't a default rule (the
                # catchall rule for the default/INITIAL state is automatically included).
                # note that :ignore =&gt; true makes the scanner ignore what it matches but doesn't
                # stop processing of the line.
          r.ignore_others '&lt;REQUEST_COMPLETED&gt;{CATCHALL}', :ignore =&gt; true

                # The &quot;strings&quot; action is special.  It keeps track of whether the last token
                # was also a string, and if it was, the new string is appended to the
                # last string instead of being pushed to the array.  For example, when scanning
                # an apache error log, ``Invalid URI in request'' will be extracted as a complete
                # string (instead of [&quot;Invalid&quot;, &quot;URI&quot;, &quot;in&quot;, &quot;request&quot;])
          r.strings '{NON_WS}{NON_WS}*'
        end

        # Writes the generated scanner and an extconf.rb for it to the directory
        # we specified when we initialized the scanner.
        scanner.write!
</pre>
<p>
There&#8216;s much in the way of documentation for the scanner generator,
but you can refer to the specs and the definitions for Apache and Rails
logs to get a sense of how it works. It would probably help a lot to learn
about flex&#8216;s regex syntax and other features.
</p>
<h1>Ruby 1.9</h1>
<p>
Ruby 1.9 is supported on the master branch. Don&#8216;t use the ruby1.9
branch, it is orphaned.
</p>
<h1>Shortcomings and Known Issues</h1>
<p>
In addition to the lack of support for formats other than Apache and Rails
described above:
</p>
<ul>
<li>It&#8216;s a new project, lots of API changes

</li>
<li>Does not convert datetimes to Ruby Time objects

</li>
<li>Does not always use context or knowledge of the log format to its
advantage. This is improving now that the scanner can utilize start
conditions.

</li>
</ul>
<h1>Performance</h1>
<p>
On my laptop, a white MacBook 2.0 GHz Intel Core Duo, teeth can process
more than 30k lines of Apache access logs per second. So it&#8216;s pretty
fast. If modified to not create a UUID or keep the full message, this can
be increased to around 45k lines/sec. One could potentially do pretty well
on the <a
href="http://www.tbray.org/ongoing/When/200x/2008/05/01/Wide-Finder-2">wide_finder2</a>&#8230;
</p>

    </div>


   </div>


  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>